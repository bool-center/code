<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信二维码工具集</title>
    <!-- 添加网站图标 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%2307C160' d='M16 0C7.163 0 0 7.163 0 16s7.163 16 16 16 16-7.163 16-16S24.837 0 16 0zm8.485 19.492c-.293.293-.677.439-1.061.439-.383 0-.768-.146-1.061-.439l-5.485-5.485-5.485 5.485c-.293.293-.677.439-1.061.439s-.768-.146-1.061-.439c-.586-.586-.586-1.535 0-2.121l7.596-7.596c.586-.586 1.535-.586 2.121 0l7.596 7.596c.586.586.586 1.535 0 2.121z'/%3E%3C/svg%3E" type="image/svg+xml">
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- QRCode.js库加载和二维码生成机制 -->
    <script>
    // 二维码库加载状态
    let qrCodeLibraryAvailable = false;
    const CDN_SOURCES = [
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
    ];
    
    // 尝试加载QRCode库
    function loadQRCodeLibrary(sources, index = 0) {
        if (index >= sources.length) {
            console.error('所有QRCode CDN加载失败');
            return;
        }
        
        const source = sources[index];
        const script = document.createElement('script');
        
        script.onload = function() {
            qrCodeLibraryAvailable = true;
            console.log(`QRCode库从 ${source} 加载成功`);
        };
        
        script.onerror = function() {
            console.warn(`QRCode库从 ${source} 加载失败，尝试第 ${index + 2} 个CDN`);
            loadQRCodeLibrary(sources, index + 1);
        };
        
        script.src = source;
        document.head.appendChild(script);
    }
    
    // 当DOM加载完成后开始加载QRCode库
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => loadQRCodeLibrary(CDN_SOURCES));
    } else {
        loadQRCodeLibrary(CDN_SOURCES);
    }
    
    // 生成真实二维码的函数
    function generateRealQRCode(canvas, text, options, callback) {
        // 检查QRCode库是否可用
        if (typeof QRCode === 'undefined') {
            // 给QRCode库一点时间加载
            setTimeout(() => {
                if (typeof QRCode === 'undefined') {
                    callback(new Error('QRCode库加载失败'));
                } else {
                    generateRealQRCode(canvas, text, options, callback);
                }
            }, 500);
            return;
        }
        
        // 使用官方QRCode库生成真实的二维码
        try {
            QRCode.toCanvas(canvas, text, options, (error) => {
                if (error) {
                    console.error('QRCode生成错误:', error);
                    callback(error);
                } else {
                    console.log('使用官方QRCode库生成了真实二维码');
                    callback(null);
                }
            });
        } catch (err) {
            console.error('QRCode生成异常:', err);
            callback(err);
        }
    }
        };
    }
    </script>
    <!-- 引入jsQR库用于解码二维码 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- 配置文件 -->
    <script src="config.js"></script>
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07C160', // 微信绿
                        secondary: '#F7F7F7',
                        dark: '#333333',
                        light: '#FFFFFF',
                        accent: '#1677FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
        </script>
        
        <!-- UI优化样式 -->
        <style>
        .btn-primary {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(7, 193, 96, 0.2);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-input {
            transition: all 0.2s ease-in-out;
        }
        
        .form-input:focus {
            transform: translateY(-1px);
        }
        
        select.form-input {
            transition: background-image 0.3s ease;
        }
        
        select.form-input:focus {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2307C160' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 12l4-4 4 4'/%3E%3C/svg%3E");
        }
        
        .tool-module {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #drop-area {
            transition: all 0.3s ease;
        }
        
        #drop-area:hover {
            background-color: rgba(7, 193, 96, 0.05);
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #07C160;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-gradient-wechat {
                background: linear-gradient(135deg, #07C160 0%, #06B055 100%);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
    <style>
        /* 自定义动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease forwards;
        }
        .animate-slideIn {
            animation: slideIn 0.5s ease forwards;
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* 输入框聚焦效果 */
        .form-input:focus {
            border-color: #07C160;
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.1);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* 下拉框样式优化 */
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        /* 下拉框交互效果增强 */
        select.form-input:hover {
            border-color: #07C160;
            transform: translateY(-1px);
        }
        
        /* 下拉框聚焦效果增强 */
        select.form-input:focus {
            border-color: #07C160;
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.2);
            outline: none;
        }
        
        /* 自定义滚动条样式 - 增强视觉效果 */
        select.form-input::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        select.form-input::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        select.form-input::-webkit-scrollbar-thumb {
            background: #07C160;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        select.form-input::-webkit-scrollbar-thumb:hover {
            background: #06B055;
            transform: scaleX(1.1);
        }
        
        /* 针对AppID和业务类型下拉框的特定样式 */
        #appid, #bustype {
            min-height: 46px;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* 下拉框选项悬停效果 */
        option:hover {
            background-color: #07C160;
            color: white;
        }
        
        /* 下拉框选项样式 */
        select.form-input option {
            padding: 0.5rem;
            transition: background-color 0.2s ease;
        }
        
        select.form-input option:hover,
        select.form-input option:checked {
            background-color: rgba(7, 193, 96, 0.1);
        }
        
        /* 输入框错误状态 */
        .form-input.error {
            border-color: #f87171;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.1);
        }
        
        /* 按钮悬停和点击效果 */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        
        /* 卡片悬停效果 */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 加载动画 */
        .loader {
            border: 3px solid rgba(7, 193, 96, 0.1);
            border-top: 3px solid #07C160;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        /* 表单标签动画 */
        .form-group {
            position: relative;
        }
        
        /* 响应式调整 */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .card-hover:hover {
                transform: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
        }
        
        /* Toast 通知样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .toast.info {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- 左侧导航栏 -->
    <aside class="w-auto bg-white shadow-lg flex-shrink-0 hidden md:block">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <i class="fa fa-qrcode text-2xl text-primary"></i>
                <h1 class="text-lg font-bold text-dark">工具集</h1>
            </div>
        </div>
        <nav class="mt-4">
            <ul>
                <li>
                    <a href="#generate" id="nav-generate" class="flex items-center px-4 py-3 text-primary bg-primary/5 border-l-4 border-primary hover:bg-primary/10 transition-colors">
                        <i class="fa fa-plus-circle w-5 mr-2"></i>
                        <span>生码工具</span>
                    </a>
                </li>
                <li>
                    <a href="#decode" id="nav-decode" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 border-l-4 border-transparent transition-colors">
                        <i class="fa fa-qrcode w-5 mr-2"></i>
                        <span>解码工具</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    
    <!-- 移动端导航按钮 -->
    <div class="fixed bottom-6 right-6 md:hidden z-50">
        <button id="mobile-nav-toggle" class="btn-primary bg-primary hover:bg-primary/90 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center">
            <i class="fa fa-bars text-xl"></i>
        </button>
    </div>
    
    <!-- 移动端侧边栏 -->
    <div id="mobile-nav" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden">
        <div class="bg-white h-full w-auto shadow-xl transform transition-transform duration-300 -translate-x-full" id="mobile-nav-content">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-qrcode text-2xl text-primary"></i>
                    <h1 class="text-lg font-bold text-dark">工具集</h1>
                </div>
                <button id="close-mobile-nav" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <nav class="mt-4">
                <ul>
                    <li>
                        <a href="#generate" id="mobile-nav-generate" class="flex items-center px-6 py-4 text-primary bg-primary/5 border-l-4 border-primary">
                            <i class="fa fa-plus-circle w-5 mr-3"></i>
                            <span>生码工具</span>
                        </a>
                    </li>
                    <li>
                        <a href="#decode" id="mobile-nav-decode" class="flex items-center px-6 py-4 text-gray-600 border-l-4 border-transparent">
                            <i class="fa fa-qrcode w-5 mr-3"></i>
                            <span>解码工具</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="flex-1 overflow-y-auto">
    <!-- 页面头部 -->
    <header class="bg-gradient-wechat text-white shadow-md">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <h1 id="page-title" class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-shadow">微信二维码生码工具</h1>
                <div class="hidden md:flex items-center space-x-4">
                    <button class="text-white hover:text-gray-200 transition-all-300">
                        <i class="fa fa-github text-xl"></i>
                    </button>
                    <button class="text-white hover:text-gray-200 transition-all-300">
                        <i class="fa fa-info-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 内容区域和页脚的容器 -->
    <div class="flex-grow flex flex-col">
        <!-- 主要内容 -->
        <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 生码工具模块 -->
        <div id="generate-module" class="tool-module">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 表单区域 -->
            <div class="bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover">
                <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                    <i class="fa fa-sliders mr-2 text-primary"></i>参数设置
                </h2>
                <form id="qrForm" class="space-y-5">
                    <!-- 错误提示区域 -->
                    <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm animate-fadeIn">
                        <i class="fa fa-exclamation-circle mr-2"></i>
                        <span id="errorText">错误信息将显示在这里</span>
                    </div>
                    <div class="form-group">
                        <label for="appid" class="block text-sm font-medium text-gray-700 mb-1">AppID <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-key"></i>
                            </span>
                            <select id="appid" name="appid" 
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 bg-white" 
                                   style="max-height: 180px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #07C160 #f1f1f1;" required>
                                <!-- AppID选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">请从下拉列表中选择AppID</p>
                    </div>

                    <div class="form-group">
                        <label for="mcid" class="block text-sm font-medium text-gray-700 mb-1">MCID <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-code"></i>
                            </span>
                            <input type="text" id="mcid" name="mcid" placeholder="请输入MCID" 
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"
                                   required>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">例如: 41941</p>
                    </div>
                    <div class="form-group">
                        <label for="tableno" class="block text-sm font-medium text-gray-700 mb-1">桌位号</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-cutlery"></i>
                            </span>
                            <input type="text" id="tableno" name="tableno" placeholder="请输入桌位号" value="001"
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">非必填，默认值为001</p>
                    </div>

                    <div class="form-group">
                        <label for="bustype" class="block text-sm font-medium text-gray-700 mb-1">业务类型</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-briefcase"></i>
                            </span>
                            <select id="bustype" name="bustype" 
                                    class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 bg-white" 
                                    style="max-height: 180px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #07C160 #f1f1f1;">
                                <!-- 选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 路径不再需要手动输入，由配置文件中的pathTemplate自动生成 -->

                    <div class="form-group">
                        <label for="qrsize" class="block text-sm font-medium text-gray-700 mb-1">二维码大小</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="qrsize" name="qrsize" min="100" max="500" value="250" step="10"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="qrsizeValue" class="text-sm font-medium text-gray-700">250px</span>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="btn-primary bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all duration-300 transform hover:scale-[1.02] hover:shadow-hover flex items-center justify-center w-full">
                            <i class="fa fa-refresh mr-2"></i>
                            生成二维码
                        </button>
                    </div>
                </form>
            </div>

            <!-- 二维码预览区域 -->
            <div class="bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                    <i class="fa fa-qrcode mr-2 text-primary"></i>二维码预览
                </h2>
                
                <!-- 成功提示区域 -->
                <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm animate-fadeIn mb-6">
                    <i class="fa fa-check-circle mr-2"></i>
                    <span id="successText">操作成功！</span>
                </div>
                
                <div class="flex flex-col items-center justify-center">
                    <div id="qrcodeContainer" class="bg-white p-6 rounded-xl shadow-custom mb-6 flex items-center justify-center relative">
                        <!-- 二维码图片将在这里生成 -->
                        <div id="qrcode" class="border border-gray-100"></div>
                        <!-- 加载指示器 -->
                        <div id="loadingIndicator" class="absolute hidden">
                            <div class="loader"></div>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">生成的链接</h3>
                        <div class="relative">
                            <input type="text" id="generatedUrl" readonly 
                                   class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 text-sm overflow-x-auto"
                                   value="https://open.weixin.qq.com/sns/getexpappinfo?appid=wx713931c9accc58f1&path=pages%2Findex%2Findex.html%3Fcontext%3DWM%26mcid%3D41941&iswxtpa=1#wechat-redirect">
                            <button id="copyButton" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-primary hover:text-primary/80 transition-colors p-2">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        <p id="copySuccess" class="hidden mt-1 text-xs text-green-500">
                            <i class="fa fa-check-circle"></i> 链接已复制到剪贴板
                        </p>
                    </div>

                    <div class="mt-6 flex flex-wrap gap-3 justify-center">
                        <button id="downloadButton" class="bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-300 flex items-center transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fa fa-download mr-2"></i>
                            下载二维码
                        </button>
                        <button id="resetButton" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow transition-all duration-300 flex items-center transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fa fa-undo mr-2"></i>
                            重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <!-- 解码工具模块 -->
        <div id="decode-module" class="tool-module hidden bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover">
            <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                <i class="fa fa-qrcode mr-2 text-primary"></i>二维码解码
            </h2>
            
            <!-- 图片上传区域 -->
            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-3">上传二维码图片</label>
                <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all duration-300 hover:border-primary hover:shadow-md">
                    <input type="file" id="qr-image-input" accept="image/*" style="display: none;">
                    <i class="fa fa-upload text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2 text-base">点击或拖拽图片到此处上传</p>
                    <p class="text-xs text-gray-500">支持 JPG, PNG, GIF 等图片格式</p>
                </div>
            </div>
            
            <!-- 预览区域 -->
            <div id="image-preview-container" class="mb-6 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">图片预览</label>
                <div class="bg-white rounded-xl border border-gray-200 p-6 flex justify-center min-h-[200px]">
                    <img id="image-preview" src="" alt="二维码预览" class="max-w-full max-h-[256px] object-contain hidden">
                </div>
            </div>
            
            <!-- 解码结果区域 -->
            <div id="decode-result-container" class="mb-6 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">解码结果</label>
                <div class="relative">
                    <textarea id="decode-result" readonly class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 font-mono text-sm min-h-[120px] resize-vertical focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea>
                    <button id="decode-copy-button" class="absolute right-3 bottom-3 bg-primary/10 text-primary rounded-md p-2 hover:bg-primary/20 transition-colors">
                        <i class="fa fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button id="decode-button" class="btn-primary bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all duration-300 transform hover:scale-[1.02] hover:shadow-hover flex items-center justify-center flex-1 opacity-50 cursor-not-allowed">
                    <i class="fa fa-search mr-2"></i> 解码二维码
                </button>
                <button id="decode-reset-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg shadow transition-all duration-300 transform hover:scale-[1.02] hover:shadow-hover flex items-center justify-center flex-1 opacity-50 cursor-not-allowed">
                    <i class="fa fa-undo mr-2"></i> 重置
                </button>
            </div>
        </div>
    </main>

    <!-- 页脚 -->

    </div>

    <!-- Toast 通知元素 -->
    <div id="toast" class="toast">
        <i class="fa fa-info-circle mr-2"></i>
        <span id="toastMessage">消息内容</span>
    </div>
    
    <!-- JavaScript -->
    <script>
        // 模块切换功能 - 全局变量
        let generateModule, decodeModule, pageTitle;
        let navGenerate, navDecode;
        let mobileNavGenerate, mobileNavDecode, mobileNavToggle, mobileNav, mobileNavContent, closeMobileNav;
        
        // 切换到生码工具
        function switchToGenerate() {
            generateModule.classList.remove('hidden');
            decodeModule.classList.add('hidden');
            // 清除解码模块的内联样式，确保hidden类正常工作
            decodeModule.style.display = '';
            decodeModule.style.visibility = '';
            decodeModule.style.opacity = '';
            pageTitle.textContent = '微信二维码生码工具';
            
            // 更新导航状态
            navGenerate.classList.add('text-primary', 'bg-primary/5', 'border-primary');
            navGenerate.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            navDecode.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
            navDecode.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            
            // 更新移动端导航状态
            mobileNavGenerate.classList.add('text-primary', 'bg-primary/5', 'border-primary');
            mobileNavGenerate.classList.remove('text-gray-600', 'border-transparent');
            mobileNavDecode.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
            mobileNavDecode.classList.add('text-gray-600', 'border-transparent');
            
            // 关闭移动端导航
            closeMobileMenu();
        }
        
        // 切换到解码工具
        function switchToDecode() {
            // 确保生成模块被隐藏，解码模块显示
            generateModule.classList.add('hidden');
            decodeModule.classList.remove('hidden');
            pageTitle.textContent = '微信二维码解码工具';
            
            // 添加调试信息
            console.log('切换到解码工具');
            console.log('generateModule hidden class:', generateModule.classList.contains('hidden'));
            console.log('decodeModule hidden class:', decodeModule.classList.contains('hidden'));
            console.log('decodeModule innerHTML length:', decodeModule.innerHTML.length);
            
            // 更新导航状态
            navDecode.classList.add('text-primary', 'bg-primary/5', 'border-primary');
            navDecode.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            navGenerate.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
            navGenerate.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            
            // 更新移动端导航状态
            mobileNavDecode.classList.add('text-primary', 'bg-primary/5', 'border-primary');
            mobileNavDecode.classList.remove('text-gray-600', 'border-transparent');
            mobileNavGenerate.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
            mobileNavGenerate.classList.add('text-gray-600', 'border-transparent');
            
            // 关闭移动端导航
            closeMobileMenu();
        }
        
        // 打开移动端菜单
        function openMobileMenu() {
            mobileNav.classList.remove('hidden');
            mobileNavContent.classList.remove('-translate-x-full');
        }
        
        // 关闭移动端菜单
        function closeMobileMenu() {
            mobileNav.classList.add('hidden');
            mobileNavContent.classList.add('-translate-x-full');
        }
        
        // 处理URL hash
        function handleHashChange() {
            const hash = window.location.hash;
            if (hash === '#decode') {
                switchToDecode();
            } else {
                switchToGenerate();
            }
        }
        
        // 模块切换功能初始化
        function initModuleNavigation() {
            generateModule = document.getElementById('generate-module');
            decodeModule = document.getElementById('decode-module');
            pageTitle = document.getElementById('page-title');
            
            // 桌面端导航
            navGenerate = document.getElementById('nav-generate');
            navDecode = document.getElementById('nav-decode');
            
            // 移动端导航
            mobileNavGenerate = document.getElementById('mobile-nav-generate');
            mobileNavDecode = document.getElementById('mobile-nav-decode');
            mobileNavToggle = document.getElementById('mobile-nav-toggle');
            mobileNav = document.getElementById('mobile-nav');
            mobileNavContent = document.getElementById('mobile-nav-content');
            closeMobileNav = document.getElementById('close-mobile-nav');
            
            // 绑定事件监听器
            navGenerate.addEventListener('click', (e) => { e.preventDefault(); switchToGenerate(); });
            navDecode.addEventListener('click', (e) => { e.preventDefault(); switchToDecode(); });
            mobileNavGenerate.addEventListener('click', (e) => { e.preventDefault(); switchToGenerate(); });
            mobileNavDecode.addEventListener('click', (e) => { e.preventDefault(); switchToDecode(); });
            mobileNavToggle.addEventListener('click', openMobileMenu);
            closeMobileNav.addEventListener('click', closeMobileMenu);
            mobileNav.addEventListener('click', (e) => { if (e.target === mobileNav) closeMobileMenu(); });
            
            // 监听hash变化
            window.addEventListener('hashchange', handleHashChange);
            
            // 初始处理
            handleHashChange();
        }
        
        // 初始化解码工具功能
        function initDecodeTool() {
            // 获取DOM元素
            const dropArea = document.getElementById('drop-area');
            const imageInput = document.getElementById('qr-image-input');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const decodeButton = document.getElementById('decode-button');
            const decodeResetButton = document.getElementById('decode-reset-button');
            const decodeResult = document.getElementById('decode-result');
            const decodeResultContainer = document.getElementById('decode-result-container');
            const decodeCopyButton = document.getElementById('decode-copy-button');
            
            let selectedFile = null;
            
            // 处理图片上传
            function handleImageUpload(file) {
                if (!file) return;
                
                // 验证文件类型
                if (!file.type.match('image.*')) {
                    alert('请上传有效的图片文件');
                    return;
                }
                
                // 验证文件大小 (最大 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片文件大小不能超过 5MB');
                    return;
                }
                
                selectedFile = file;
                
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imagePreviewContainer.style.display = 'block';
                    decodeButton.style.opacity = '1';
                    decodeButton.style.cursor = 'pointer';
                    decodeResetButton.style.opacity = '1';
                    decodeResetButton.style.cursor = 'pointer';
                    decodeResultContainer.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
            
            // 解码二维码
            function decodeQRCode() {
                if (!selectedFile) {
                    alert('请先上传图片');
                    return;
                }
                
                // 创建canvas用于解码
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 设置canvas大小
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // 绘制图像
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    
                    // 获取图像数据
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // 使用jsQR解码
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert"
                    });
                    
                    // 处理解码结果
                    if (code) {
                        decodeResult.value = code.data;
                        decodeResultContainer.style.display = 'block';
                    } else {
                        alert('未检测到二维码或解码失败，请尝试其他图片');
                    }
                };
                
                img.onerror = function() {
                    alert('图片加载失败，请重试');
                };
                
                img.src = imagePreview.src;
            }
            
            // 重置解码工具
            function resetDecodeTool() {
                imageInput.value = '';
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                imagePreviewContainer.style.display = 'none';
                decodeResult.value = '';
                decodeResultContainer.style.display = 'none';
                selectedFile = null;
                decodeButton.style.opacity = '0.5';
                decodeButton.style.cursor = 'not-allowed';
                decodeResetButton.style.opacity = '0.5';
                decodeResetButton.style.cursor = 'not-allowed';
            }
            
            // 复制解码结果
            function copyDecodeResult() {
                if (decodeResult.value) {
                    decodeResult.select();
                    decodeResult.setSelectionRange(0, 99999);
                    
                    try {
                        document.execCommand('copy');
                        alert('解码结果已复制到剪贴板');
                    } catch (err) {
                        alert('复制失败，请手动复制');
                    }
                }
            }
            
            // 绑定事件监听器
            // 点击上传区域触发文件选择
            dropArea.addEventListener('click', () => {
                imageInput.click();
            });
            
            // 文件选择事件
            imageInput.addEventListener('change', () => {
                handleImageUpload(imageInput.files[0]);
            });
            
            // 解码按钮事件
            decodeButton.addEventListener('click', decodeQRCode);
            
            // 重置按钮事件
            decodeResetButton.addEventListener('click', resetDecodeTool);
            
            // 复制按钮事件
            decodeCopyButton.addEventListener('click', copyDecodeResult);
            
            // 拖拽上传功能事件监听
            // 阻止默认行为，避免浏览器打开文件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            // 防止拖拽事件的默认行为
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // 拖拽悬停时的视觉反馈
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            // 拖拽离开或放下时移除视觉反馈
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            // 添加拖拽样式
            function highlight() {
                dropArea.classList.add('border-accent', 'bg-blue-50');
                dropArea.classList.remove('border-gray-300', 'bg-gray-50', 'hover:bg-gray-100');
            }
            
            // 移除拖拽样式
            function unhighlight() {
                dropArea.classList.remove('border-accent', 'bg-blue-50');
                dropArea.classList.add('border-gray-300', 'bg-gray-50', 'hover:bg-gray-100');
            }
            
            // 处理拖拽文件放置
            dropArea.addEventListener('drop', handleDrop, false);
            
            // 处理拖拽放置的文件
            function handleDrop(e) {
                 const dt = e.dataTransfer;
                 const files = dt.files;
                 
                 if (files.length > 0) {
                     handleImageUpload(files[0]);
                 }
             }
        }
        // Toast 通知函数
        function showToast(type, message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            // 移除之前的类型类
            toast.classList.remove('success', 'error', 'info');
            
            // 添加新的类型类
            toast.classList.add(type);
            
            // 更新消息内容
            toastMessage.textContent = message;
            
            // 更新图标
            const icon = toast.querySelector('i');
            icon.className = 'fa mr-2';
            
            if (type === 'success') {
                icon.classList.add('fa-check-circle');
            } else if (type === 'error') {
                icon.classList.add('fa-exclamation-circle');
            } else {
                icon.classList.add('fa-info-circle');
            }
            
            // 显示Toast
            toast.classList.add('show');
            
            // 设置定时器自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 表单验证函数
        function validateForm() {
            let isValid = true;
            const errorMessageElement = document.getElementById('errorMessage');
            const errorTextElement = document.getElementById('errorText');
            
            // 隐藏之前的错误消息
            errorMessageElement.classList.add('hidden');
            
            // 验证AppID (下拉选择)
            const appidSelect = document.getElementById('appid');
            const appid = appidSelect.value;
            
            if (!appid) {
                showError(appidSelect, '请选择AppID');
                isValid = false;
            } else {
                removeError(appidSelect);
            }
            
            // 验证MCID（非必填，但如果填写必须是数字）
            const mcidInput = document.getElementById('mcid');
            const mcid = mcidInput.value.trim();
            
            if (mcid && !/^[0-9]+$/.test(mcid)) {
                showError(mcidInput, 'MCID只能包含数字');
                isValid = false;
            } else {
                removeError(mcidInput);
            }
            
            return isValid;
        }
        
        // 显示输入框错误
        function showError(inputElement, message) {
            inputElement.classList.add('error', 'animate-shake');
            
            // 移除动画类，以便下次可以重新触发
            setTimeout(() => {
                inputElement.classList.remove('animate-shake');
            }, 500);
            
            const errorMessageElement = document.getElementById('errorMessage');
            const errorTextElement = document.getElementById('errorText');
            
            errorTextElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
        }
        
        // 移除输入框错误
        function removeError(inputElement) {
            inputElement.classList.remove('error');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟执行，确保DOM完全渲染
            setTimeout(() => {
                // 初始化模块导航
                try {
                    initModuleNavigation();
                    console.log('模块导航初始化完成');
                } catch (error) {
                    console.error('初始化模块导航失败:', error);
                }
                
                // 初始化解码工具
                try {
                    initDecodeTool();
                    console.log('解码工具初始化完成');
                } catch (error) {
                    console.error('初始化解码工具失败:', error);
                }
                
                // 初始化AppID下拉选择框
                try {
                    initAppidDropdown();
                    console.log('AppID下拉选择框初始化完成');
                } catch (error) {
                    console.error('初始化AppID下拉选择框失败:', error);
                }
                
                // 初始化业务类型下拉框
                try {
                    initBustypeDropdown();
                    console.log('业务类型下拉框初始化完成');
                } catch (error) {
                    console.error('初始化业务类型下拉框失败:', error);
                }
                
                // 初始化默认二维码，添加错误处理以防止页面加载失败
                try {
                    generateQRCode();
                    console.log('默认二维码初始化完成');
                } catch (error) {
                    console.error('初始化默认二维码时出错:', error);
                    // 确保加载指示器被隐藏
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.classList.add('hidden');
                    }
                    // 显示友好的错误提示
                    const qrcodeElement = document.getElementById('qrcode');
                    if (qrcodeElement) {
                        qrcodeElement.innerHTML = '<p class="text-gray-500">二维码初始化中...</p>';
                    }
                }
            
                // 添加调试信息
                console.log('DOMContentLoaded事件执行完成');
                console.log('decode-module element:', document.getElementById('decode-module'));
                console.log('nav-decode element:', document.getElementById('nav-decode'));
                console.log('switchToDecode function:', typeof switchToDecode);
            }, 100); // 短暂延迟，确保DOM完全渲染
            
            // 页面加载完成后默认显示生码模块
            // 注释掉自动调用switchToDecode()的代码，确保默认显示生码模块
            
            // 为必填字段添加输入事件监听器
            const requiredInputs = ['appid', 'mcid'];
            requiredInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('change', function() {
                    if (this.classList.contains('error')) {
                        removeError(this);
                        document.getElementById('errorMessage').classList.add('hidden');
                    }
                });
                
                // 为mcid添加input事件
                if (id === 'mcid') {
                    input.addEventListener('input', function() {
                        if (this.classList.contains('error')) {
                            removeError(this);
                            document.getElementById('errorMessage').classList.add('hidden');
                        }
                    });
                }
            });
            
            // 初始化AppID下拉选择框
            function initAppidDropdown() {
                const appidSelect = document.getElementById('appid');
                
                // 清空现有选项
                appidSelect.innerHTML = '';
                
                // 添加默认占位选项
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- 请选择AppID --';
                placeholderOption.selected = true;
                placeholderOption.disabled = true;
                appidSelect.appendChild(placeholderOption);
                
                // 从配置中添加AppID选项
                if (typeof config !== 'undefined' && config.appidList && config.appidList.length > 0) {
                    config.appidList.forEach((app, index) => {
                        const option = document.createElement('option');
                        option.value = app.value;
                        option.textContent = app.name + ' (' + app.value + ')';
                        
                        // 默认选中第一个有效选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        appidSelect.appendChild(option);
                    });
                } else {
                    // 如果配置未定义，添加默认选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'wx713931c9accc58f1';
                    defaultOption.textContent = '默认应用 (wx713931c9accc58f1)';
                    defaultOption.selected = true;
                    appidSelect.appendChild(defaultOption);
                }
            }
            
            // 初始化业务类型下拉框
            function initBustypeDropdown() {
                const bustypeSelect = document.getElementById('bustype');
                
                // 清空现有选项
                bustypeSelect.innerHTML = '';
                
                // 添加默认占位选项
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- 请选择业务类型 --';
                placeholderOption.selected = true;
                placeholderOption.disabled = true;
                bustypeSelect.appendChild(placeholderOption);
                
                // 从配置中添加业务类型选项
                if (typeof config !== 'undefined' && config.bustypeList && config.bustypeList.length > 0) {
                    config.bustypeList.forEach((bustype, index) => {
                        const option = document.createElement('option');
                        option.value = bustype.value;
                        option.textContent = bustype.name + ' (' + bustype.value + ')';
                        
                        // 默认选中第一个有效选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        bustypeSelect.appendChild(option);
                    });
                } else {
                    // 如果配置未定义，添加默认选项
                    const defaultOptions = [
                        {value: 'WM', name: '外卖'},
                        {value: 'JD', name: '京东'},
                        {value: 'EL', name: '饿了么'},
                        {value: 'OTHER', name: '其他'}
                    ];
                    
                    defaultOptions.forEach((opt, index) => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.name + ' (' + opt.value + ')';
                        
                        // 默认选中第一个选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        bustypeSelect.appendChild(option);
                    });
                }
                
                // 设置默认值（如果配置中有指定）
                if (typeof config !== 'undefined' && config.defaultParams && config.defaultParams.bustype) {
                    bustypeSelect.value = config.defaultParams.bustype;
                }
            }
            
            // 监听表单提交事件
            document.getElementById('qrForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 验证表单
                if (validateForm()) {
                    generateQRCode();
                    
                    // 显示成功消息
                    const successMessage = document.getElementById('successMessage');
                    const successText = document.getElementById('successText');
                    successText.textContent = '二维码生成成功！';
                    successMessage.classList.remove('hidden');
                    
                    // 3秒后隐藏成功消息
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 3000);
                    
                    // 添加提交动画效果
                    const submitButton = this.querySelector('button[type="submit"]');
                    submitButton.classList.add('animate-pulse');
                    setTimeout(() => {
                        submitButton.classList.remove('animate-pulse');
                    }, 1000);
                }
            });
            
            // 监听滑块变化
            document.getElementById('qrsize').addEventListener('input', function() {
                document.getElementById('qrsizeValue').textContent = this.value + 'px';
            });
            
            // 复制链接功能
            document.getElementById('copyButton').addEventListener('click', function() {
                const urlInput = document.getElementById('generatedUrl');
                
                try {
                    // 尝试使用现代的 Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(urlInput.value).then(() => {
                            showToast('success', '链接已复制到剪贴板');
                        }).catch(() => {
                            // 降级到传统方法
                            fallbackCopyTextToClipboard(urlInput);
                        });
                    } else {
                        // 降级到传统方法
                        fallbackCopyTextToClipboard(urlInput);
                    }
                } catch (err) {
                    showToast('error', '复制失败，请手动复制');
                }
            });
            
            // 传统的复制文本方法
            function fallbackCopyTextToClipboard(inputElement) {
                inputElement.select();
                inputElement.setSelectionRange(0, 99999); // 兼容移动设备
                
                if (document.execCommand('copy')) {
                    showToast('success', '链接已复制到剪贴板');
                } else {
                    showToast('error', '复制失败，请手动复制');
                }
            }
            
            // 下载二维码功能
            document.getElementById('downloadButton').addEventListener('click', function() {
                const canvas = document.querySelector('#qrcode canvas');
                if (canvas) {
                    try {
                        const link = document.createElement('a');
                        link.download = 'wechat_qrcode_' + new Date().getTime() + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        showToast('success', '二维码下载成功');
                    } catch (err) {
                        showToast('error', '下载失败，请重试');
                    }
                } else {
                    showToast('error', '二维码未生成，请先生成二维码');
                }
            });
            
            // 为二维码大小滑块添加实时更新功能
            document.getElementById('qrsize').addEventListener('input', function() {
                // 更新显示的大小值
                const sizeValue = this.value;
                document.getElementById('qrsizeValue').textContent = sizeValue + 'px';
                
                // 验证表单并实时更新二维码大小
                if (validateForm()) {
                    generateQRCode();
                }
            });
            
            // 重置功能
            document.getElementById('resetButton').addEventListener('click', function() {
                // 重置表单
                document.getElementById('qrForm').reset();
                document.getElementById('qrsizeValue').textContent = '250px';
                
                // 重置下拉框
                initAppidDropdown();
                initBustypeDropdown();
                
                // 如果有默认参数配置，应用默认值
                if (typeof config !== 'undefined' && config.defaultParams) {
                    const defaults = config.defaultParams;
                    // mcid不再设置默认值，保持为空
                    document.getElementById('tableno').value = defaults.tableno || '001';
                    document.getElementById('qrsize').value = defaults.qrsize || 250;
                    document.getElementById('qrsizeValue').textContent = (defaults.qrsize || 250) + 'px';
                }
                
                // 移除所有错误状态
                document.querySelectorAll('.form-input').forEach(input => {
                    removeError(input);
                });
                document.getElementById('errorMessage').classList.add('hidden');
                
                // 重置后重新生成默认二维码
                generateQRCode();
                showToast('info', '已重置为默认值');
            });
        });
        
        // 生成二维码的函数
        function generateQRCode() {
            // 检查必要的DOM元素是否存在
            const requiredElements = {
                loadingIndicator: document.getElementById('loadingIndicator'),
                appid: document.getElementById('appid'),
                mcid: document.getElementById('mcid'),
                tableno: document.getElementById('tableno'),
                bustype: document.getElementById('bustype'),
                qrsize: document.getElementById('qrsize'),
                qrcode: document.getElementById('qrcode'),
                generatedUrl: document.getElementById('generatedUrl')
            };
            
            // 验证所有必要元素是否存在
            for (const [key, element] of Object.entries(requiredElements)) {
                if (!element) {
                    console.error(`必要DOM元素未找到: ${key}`);
                    return;
                }
            }
            
            // 显示加载指示器
            requiredElements.loadingIndicator.classList.remove('hidden');
            
            // 获取表单值
            const appid = requiredElements.appid.value.trim() || 'wx713931c9accc58f1';
            const mcid = requiredElements.mcid.value.trim();
            const tableno = requiredElements.tableno.value.trim() || '001';
            const bustype = requiredElements.bustype.value || 'WM';
            const qrsize = parseInt(requiredElements.qrsize.value) || 250;
            
            try {
                // 检查配置对象是否正确加载
                if (typeof config === 'undefined') {
                    console.error('配置文件未加载或未定义config对象');
                    // 使用默认配置
                    config = {
                        bustypeList: [
                            { name: '外卖', value: 'WM', pathTemplate: 'pages/index/index.html?context=WM&mcid={{mcid}}&iswxtpa=1#wechat-redirect' },
                            { name: '自提', value: 'ZT', pathTemplate: 'pages/index/index.html?context=ZT&mcid={{mcid}}&iswxtpa=1#wechat-redirect' },
                            { name: '点餐', value: 'DC', pathTemplate: 'pages/index/index.html?context=DC&mcid={{mcid}}&iswxtpa=1#wechat-redirect' },
                            { name: '我的订单', value: 'OD', pathTemplate: 'pages/index/index.html?context=OD&page=myOrder&mcid={{mcid}}&tableno={{tableno}}&iswxtpa=1#wechat-redirect' }
                        ]
                    };
                }
                
                // 根据bustype从配置中获取pathTemplate
                let path;
                
                if (config.bustypeList) {
                    const selectedBustype = config.bustypeList.find(item => item.value === bustype);
                    if (selectedBustype && selectedBustype.pathTemplate) {
                        // 使用pathTemplate替换所有占位符，确保mcid和tableno始终存在
                        path = selectedBustype.pathTemplate.replace('{{mcid}}', mcid).replace('{{tableno}}', tableno);
                    } else {
                        // 默认构建路径，确保mcid和tableno始终存在
                        path = 'pages/index/index.html?context=' + bustype + '&mcid=' + mcid + '&tableno=' + tableno + '&iswxtpa=1#wechat-redirect';
                    }
                } else {
                    // 默认构建路径，确保mcid和tableno始终存在
                    path = 'pages/index/index.html?context=' + bustype + '&mcid=' + mcid + '&tableno=' + tableno + '&iswxtpa=1#wechat-redirect';
                }
                
                // 对整个路径进行URL编码
                const encodedPath = encodeURIComponent(path);
                
                // 构建最终的URL，确保包含必要的iswxtpa参数
                const url = `https://open.weixin.qq.com/sns/getexpappinfo?appid=${appid}&path=${encodedPath}&iswxtpa=1#wechat-redirect`;
                
                // 更新显示的URL
                requiredElements.generatedUrl.value = url;
                
                // 重试配置
                const MAX_RETRIES = 3;
                const RETRY_DELAY = 500; // 毫秒
                let retryCount = 0;
                
                // 创建生成二维码的函数（支持重试）
                function generateWithRetry() {
                    // 清空之前的二维码
                    requiredElements.qrcode.innerHTML = '<canvas></canvas>';
                    const canvas = requiredElements.qrcode.querySelector('canvas');
                    
                    // 使用新的generateRealQRCode函数生成真实二维码
                    generateRealQRCode(canvas, url, {
                        width: qrsize,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#ffffff'
                        }
                    }, function(error) {
                        if (error) {
                            retryCount++;
                            console.warn(`二维码生成失败 (${retryCount}/${MAX_RETRIES}):`, error);
                            
                            if (retryCount < MAX_RETRIES) {
                                // 重试
                                console.log(`将在 ${RETRY_DELAY}ms 后进行第 ${retryCount + 1} 次重试...`);
                                setTimeout(generateWithRetry, RETRY_DELAY);
                            } else {
                                // 达到最大重试次数
                                console.error('已达到最大重试次数，二维码生成失败');
                                requiredElements.loadingIndicator.classList.add('hidden');
                                requiredElements.qrcode.innerHTML = '<p class="text-red-500">生成二维码时出错，请检查网络连接或稍后重试</p>';
                                showToast('error', '生成二维码失败，请检查网络连接或稍后重试');
                            }
                        } else {
                            // 成功生成二维码
                            requiredElements.loadingIndicator.classList.add('hidden');
                            
                            // 添加生成成功的动画效果
                            requiredElements.qrcode.classList.add('animate-fadeIn');
                            setTimeout(() => {
                                requiredElements.qrcode.classList.remove('animate-fadeIn');
                            }, 500);
                        }
                    });
                }
                
                // 开始生成二维码（支持重试）
                generateWithRetry();
            } catch (err) {
                // 隐藏加载指示器
                requiredElements.loadingIndicator.classList.add('hidden');
                console.error('生成过程中发生错误:', err);
                showToast('error', '生成二维码时发生错误，请重试');
            }
        }
    </script>
</body>
</html>