<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信二维码工具集</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入QRCode.js库用于生成二维码 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- 引入jsQR库用于解码二维码 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- 配置文件 -->
    <script src="config.js"></script>
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07C160', // 微信绿
                        secondary: '#F7F7F7',
                        dark: '#333333',
                        light: '#FFFFFF',
                        accent: '#1677FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
        </script>
        
        <!-- UI优化样式 -->
        <style>
        .btn-primary {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(7, 193, 96, 0.2);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-input {
            transition: all 0.2s ease-in-out;
        }
        
        .form-input:focus {
            transform: translateY(-1px);
        }
        
        select.form-input {
            transition: background-image 0.3s ease;
        }
        
        select.form-input:focus {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2307C160' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 12l4-4 4 4'/%3E%3C/svg%3E");
        }
        
        .tool-module {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #drop-area {
            transition: all 0.3s ease;
        }
        
        #drop-area:hover {
            background-color: rgba(7, 193, 96, 0.05);
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #07C160;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-gradient-wechat {
                background: linear-gradient(135deg, #07C160 0%, #06B055 100%);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
    <style>
        /* 自定义动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease forwards;
        }
        .animate-slideIn {
            animation: slideIn 0.5s ease forwards;
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* 输入框聚焦效果 */
        .form-input:focus {
            border-color: #07C160;
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.1);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* 下拉框样式优化 */
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        select.form-input::-webkit-scrollbar {
            width: 6px;
        }
        
        select.form-input::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        select.form-input::-webkit-scrollbar-thumb {
            background: #07C160;
            border-radius: 3px;
        }
        
        select.form-input::-webkit-scrollbar-thumb:hover {
            background: #06B055;
        }
        
        /* 下拉框选项样式 */
        select.form-input option {
            padding: 0.5rem;
            transition: background-color 0.2s ease;
        }
        
        select.form-input option:hover,
        select.form-input option:checked {
            background-color: rgba(7, 193, 96, 0.1);
        }
        
        /* 输入框错误状态 */
        .form-input.error {
            border-color: #f87171;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.1);
        }
        
        /* 按钮悬停和点击效果 */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        
        /* 卡片悬停效果 */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 加载动画 */
        .loader {
            border: 3px solid rgba(7, 193, 96, 0.1);
            border-top: 3px solid #07C160;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        /* 表单标签动画 */
        .form-group {
            position: relative;
        }
        
        /* 响应式调整 */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .card-hover:hover {
                transform: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
        }
        
        /* Toast 通知样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .toast.info {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex overflow-hidden">
    <!-- 左侧导航栏 -->
    <aside class="w-64 bg-white shadow-lg flex-shrink-0 hidden md:block">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <i class="fa fa-qrcode text-2xl text-primary"></i>
                <h1 class="text-lg font-bold text-dark">工具集</h1>
            </div>
        </div>
        <nav class="mt-4">
            <ul>
                <li>
                    <a href="#generate" id="nav-generate" class="flex items-center px-6 py-4 text-primary bg-primary/5 border-l-4 border-primary hover:bg-primary/10 transition-colors">
                        <i class="fa fa-plus-circle w-5 mr-3"></i>
                        <span>生码工具</span>
                    </a>
                </li>
                <li>
                    <a href="#decode" id="nav-decode" class="flex items-center px-6 py-4 text-gray-600 hover:bg-gray-50 border-l-4 border-transparent transition-colors">
                        <i class="fa fa-qrcode w-5 mr-3"></i>
                        <span>解码工具</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    
    <!-- 移动端导航按钮 -->
    <div class="fixed bottom-6 right-6 md:hidden z-50">
        <button id="mobile-nav-toggle" class="btn-primary bg-primary hover:bg-primary/90 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center">
            <i class="fa fa-bars text-xl"></i>
        </button>
    </div>
    
    <!-- 移动端侧边栏 -->
    <div id="mobile-nav" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden">
        <div class="bg-white h-full w-64 shadow-xl transform transition-transform duration-300 -translate-x-full" id="mobile-nav-content">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-qrcode text-2xl text-primary"></i>
                    <h1 class="text-lg font-bold text-dark">工具集</h1>
                </div>
                <button id="close-mobile-nav" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <nav class="mt-4">
                <ul>
                    <li>
                        <a href="#generate" id="mobile-nav-generate" class="flex items-center px-6 py-4 text-primary bg-primary/5 border-l-4 border-primary">
                            <i class="fa fa-plus-circle w-5 mr-3"></i>
                            <span>生码工具</span>
                        </a>
                    </li>
                    <li>
                        <a href="#decode" id="mobile-nav-decode" class="flex items-center px-6 py-4 text-gray-600 border-l-4 border-transparent">
                            <i class="fa fa-qrcode w-5 mr-3"></i>
                            <span>解码工具</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="flex-1 overflow-y-auto">
    <!-- 页面头部 -->
    <header class="bg-gradient-wechat text-white shadow-md">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <h1 id="page-title" class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-shadow">微信二维码生码工具</h1>
                <div class="hidden md:flex items-center space-x-4">
                    <button class="text-white hover:text-gray-200 transition-all-300">
                        <i class="fa fa-github text-xl"></i>
                    </button>
                    <button class="text-white hover:text-gray-200 transition-all-300">
                        <i class="fa fa-info-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 生码工具模块 -->
        <div id="generate-module" class="tool-module">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 表单区域 -->
            <div class="bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover">
                <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                    <i class="fa fa-sliders mr-2 text-primary"></i>参数设置
                </h2>
                <form id="qrForm" class="space-y-5">
                    <!-- 错误提示区域 -->
                    <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm animate-fadeIn">
                        <i class="fa fa-exclamation-circle mr-2"></i>
                        <span id="errorText">错误信息将显示在这里</span>
                    </div>
                    <div class="form-group">
                        <label for="appid" class="block text-sm font-medium text-gray-700 mb-1">AppID <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-key"></i>
                            </span>
                            <select id="appid" name="appid" 
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 bg-white" 
                                   style="max-height: 180px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #07C160 #f1f1f1;" required>
                                <!-- AppID选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">请从下拉列表中选择AppID</p>
                    </div>

                    <div class="form-group">
                        <label for="mcid" class="block text-sm font-medium text-gray-700 mb-1">MCID <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-code"></i>
                            </span>
                            <input type="text" id="mcid" name="mcid" placeholder="请输入MCID" 
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"
                                   required>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">例如: 41941</p>
                    </div>
                    <div class="form-group">
                        <label for="tableno" class="block text-sm font-medium text-gray-700 mb-1">桌位号</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-cutlery"></i>
                            </span>
                            <input type="text" id="tableno" name="tableno" placeholder="请输入桌位号" value="001"
                                   class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">非必填，默认值为001</p>
                    </div>

                    <div class="form-group">
                        <label for="bustype" class="block text-sm font-medium text-gray-700 mb-1">业务类型</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-briefcase"></i>
                            </span>
                            <select id="bustype" name="bustype" 
                                    class="form-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 bg-white" 
                                    style="max-height: 180px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #07C160 #f1f1f1;">
                                <!-- 选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 路径不再需要手动输入，由配置文件中的pathTemplate自动生成 -->

                    <div class="form-group">
                        <label for="qrsize" class="block text-sm font-medium text-gray-700 mb-1">二维码大小</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="qrsize" name="qrsize" min="100" max="500" value="250" step="10"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="qrsizeValue" class="text-sm font-medium text-gray-700">250px</span>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="btn-primary bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all duration-300 transform hover:scale-[1.02] hover:shadow-hover flex items-center justify-center w-full">
                            <i class="fa fa-refresh mr-2"></i>
                            生成二维码
                        </button>
                    </div>
                </form>
            </div>

            <!-- 二维码预览区域 -->
            <div class="bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                    <i class="fa fa-qrcode mr-2 text-primary"></i>二维码预览
                </h2>
                
                <!-- 成功提示区域 -->
                <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm animate-fadeIn mb-6">
                    <i class="fa fa-check-circle mr-2"></i>
                    <span id="successText">操作成功！</span>
                </div>
                
                <div class="flex flex-col items-center justify-center">
                    <div id="qrcodeContainer" class="bg-white p-6 rounded-xl shadow-custom mb-6 flex items-center justify-center relative">
                        <!-- 二维码图片将在这里生成 -->
                        <div id="qrcode" class="border border-gray-100"></div>
                        <!-- 加载指示器 -->
                        <div id="loadingIndicator" class="absolute hidden">
                            <div class="loader"></div>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">生成的链接</h3>
                        <div class="relative">
                            <input type="text" id="generatedUrl" readonly 
                                   class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 text-sm overflow-x-auto"
                                   value="https://open.weixin.qq.com/sns/getexpappinfo?appid=wx713931c9accc58f1&path=pages%2Findex%2Findex.html%3Fcontext%3DWM%26mcid%3D41941&iswxtpa=1#wechat-redirect">
                            <button id="copyButton" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-primary hover:text-primary/80 transition-colors p-2">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        <p id="copySuccess" class="hidden mt-1 text-xs text-green-500">
                            <i class="fa fa-check-circle"></i> 链接已复制到剪贴板
                        </p>
                    </div>

                    <div class="mt-6 flex flex-wrap gap-3 justify-center">
                        <button id="downloadButton" class="bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-300 flex items-center transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fa fa-download mr-2"></i>
                            下载二维码
                        </button>
                        <button id="resetButton" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow transition-all duration-300 flex items-center transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fa fa-undo mr-2"></i>
                            重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 解码工具模块 (初始隐藏) -->
        <div id="decode-module" class="tool-module hidden">
            <div class="bg-white rounded-2xl shadow-custom p-6 animate-fadeIn card-hover">
                <h2 class="text-xl font-bold mb-6 text-dark flex items-center animate-slideIn">
                    <i class="fa fa-qrcode mr-2 text-primary"></i>二维码解码
                </h2>
                
                <!-- 错误提示区域 -->
                <div id="decode-errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm animate-fadeIn">
                    <i class="fa fa-exclamation-circle mr-2"></i>
                    <span id="decode-errorText">错误信息将显示在这里</span>
                </div>
                
                <!-- 成功提示区域 -->
                <div id="decode-successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm animate-fadeIn mb-6">
                    <i class="fa fa-check-circle mr-2"></i>
                    <span id="decode-successText">解码成功！</span>
                </div>
                
                <!-- 图片上传区域 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">上传二维码图片</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary transition-colors cursor-pointer bg-gray-50" id="drop-area">
                        <input type="file" id="qr-image-input" accept="image/*" class="hidden">
                        <i class="fa fa-upload text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">点击或拖拽图片到此处上传</p>
                        <p class="text-xs text-gray-500">支持 JPG, PNG, GIF 等图片格式</p>
                    </div>
                </div>
                
                <!-- 预览区域 -->
                <div id="image-preview-container" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片预览</label>
                    <div class="bg-white rounded-lg border border-gray-200 p-4 flex justify-center" style="min-height: 200px;">
                        <img id="image-preview" src="" alt="二维码预览" class="max-w-full max-h-64 object-contain">
                    </div>
                </div>
                
                <!-- 解码结果区域 -->
                <div id="decode-result-container" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">解码结果</label>
                    <div class="relative">
                        <textarea id="decode-result" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 text-sm overflow-auto min-h-[100px] font-mono" placeholder="解码结果将显示在这里..."></textarea>
                        <button id="decode-copy-button" class="absolute right-2 bottom-2 bg-primary/10 text-primary hover:bg-primary/20 transition-colors p-2 rounded">
                            <i class="fa fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="pt-4 flex gap-4">
                    <button id="decode-button" class="btn-primary bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all duration-300 transform hover:scale-[1.02] hover:shadow-hover flex items-center justify-center flex-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-search mr-2"></i>
                        解码二维码
                    </button>
                    <button id="decode-reset-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg shadow transition-all duration-300 flex items-center justify-center flex-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-undo mr-2"></i>
                        重置
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-gray-400 text-sm">© 2024 微信二维码工具集. 保留所有权利.</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-github"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-linkedin"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast 通知元素 -->
    <div id="toast" class="toast">
        <i class="fa fa-info-circle mr-2"></i>
        <span id="toastMessage">消息内容</span>
    </div>
    
    <!-- JavaScript -->
    <script>
        // 模块切换功能
        function initModuleNavigation() {
            const generateModule = document.getElementById('generate-module');
            const decodeModule = document.getElementById('decode-module');
            const pageTitle = document.getElementById('page-title');
            
            // 桌面端导航
            const navGenerate = document.getElementById('nav-generate');
            const navDecode = document.getElementById('nav-decode');
            
            // 移动端导航
            const mobileNavGenerate = document.getElementById('mobile-nav-generate');
            const mobileNavDecode = document.getElementById('mobile-nav-decode');
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const mobileNav = document.getElementById('mobile-nav');
            const mobileNavContent = document.getElementById('mobile-nav-content');
            const closeMobileNav = document.getElementById('close-mobile-nav');
            
            // 切换到生码工具
            function switchToGenerate() {
                generateModule.classList.remove('hidden');
                decodeModule.classList.add('hidden');
                pageTitle.textContent = '微信二维码生码工具';
                
                // 更新导航状态
                navGenerate.classList.add('text-primary', 'bg-primary/5', 'border-primary');
                navGenerate.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
                navDecode.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
                navDecode.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
                
                // 更新移动端导航状态
                mobileNavGenerate.classList.add('text-primary', 'bg-primary/5', 'border-primary');
                mobileNavGenerate.classList.remove('text-gray-600', 'border-transparent');
                mobileNavDecode.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
                mobileNavDecode.classList.add('text-gray-600', 'border-transparent');
                
                // 关闭移动端导航
                closeMobileMenu();
            }
            
            // 切换到解码工具
            function switchToDecode() {
                generateModule.classList.add('hidden');
                decodeModule.classList.remove('hidden');
                pageTitle.textContent = '微信二维码解码工具';
                
                // 更新导航状态
                navDecode.classList.add('text-primary', 'bg-primary/5', 'border-primary');
                navDecode.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
                navGenerate.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
                navGenerate.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
                
                // 更新移动端导航状态
                mobileNavDecode.classList.add('text-primary', 'bg-primary/5', 'border-primary');
                mobileNavDecode.classList.remove('text-gray-600', 'border-transparent');
                mobileNavGenerate.classList.remove('text-primary', 'bg-primary/5', 'border-primary');
                mobileNavGenerate.classList.add('text-gray-600', 'border-transparent');
                
                // 关闭移动端导航
                closeMobileMenu();
            }
            
            // 打开移动端菜单
            function openMobileMenu() {
                mobileNav.classList.remove('hidden');
                mobileNavContent.classList.remove('-translate-x-full');
            }
            
            // 关闭移动端菜单
            function closeMobileMenu() {
                mobileNav.classList.add('hidden');
                mobileNavContent.classList.add('-translate-x-full');
            }
            
            // 绑定事件监听器
            if (navGenerate) navGenerate.addEventListener('click', (e) => { e.preventDefault(); switchToGenerate(); });
            if (navDecode) navDecode.addEventListener('click', (e) => { e.preventDefault(); switchToDecode(); });
            if (mobileNavGenerate) mobileNavGenerate.addEventListener('click', (e) => { e.preventDefault(); switchToGenerate(); });
            if (mobileNavDecode) mobileNavDecode.addEventListener('click', (e) => { e.preventDefault(); switchToDecode(); });
            if (mobileNavToggle) mobileNavToggle.addEventListener('click', openMobileMenu);
            if (closeMobileNav) closeMobileNav.addEventListener('click', closeMobileMenu);
            if (mobileNav) mobileNav.addEventListener('click', (e) => { if (e.target === mobileNav) closeMobileMenu(); });
            
            // 处理URL hash
            function handleHashChange() {
                const hash = window.location.hash;
                if (hash === '#decode') {
                    switchToDecode();
                } else {
                    switchToGenerate();
                }
            }
            
            // 监听hash变化
            window.addEventListener('hashchange', handleHashChange);
            
            // 初始处理
            handleHashChange();
        }
        
        // 初始化解码工具功能
        function initDecodeTool() {
            const dropArea = document.getElementById('drop-area');
            const imageInput = document.getElementById('qr-image-input');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const decodeButton = document.getElementById('decode-button');
            const decodeResetButton = document.getElementById('decode-reset-button');
            const decodeResult = document.getElementById('decode-result');
            const decodeResultContainer = document.getElementById('decode-result-container');
            const decodeCopyButton = document.getElementById('decode-copy-button');
            const errorMessage = document.getElementById('decode-errorMessage');
            const errorText = document.getElementById('decode-errorText');
            const successMessage = document.getElementById('decode-successMessage');
            const successText = document.getElementById('decode-successText');
            
            let selectedFile = null;
            
            // 显示错误信息
            function showDecodeError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                setTimeout(() => {
                    errorMessage.classList.add('hidden');
                }, 3000);
            }
            
            // 显示成功信息
            function showDecodeSuccess(message) {
                successText.textContent = message;
                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);
            }
            
            // 处理图片上传
            function handleImageUpload(file) {
                if (!file) return;
                
                // 验证文件类型
                if (!file.type.match('image.*')) {
                    showDecodeError('请上传有效的图片文件');
                    return;
                }
                
                // 验证文件大小 (最大 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showDecodeError('图片文件大小不能超过 5MB');
                    return;
                }
                
                selectedFile = file;
                
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    decodeButton.disabled = false;
                    decodeResetButton.disabled = false;
                    decodeResultContainer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            // 解码二维码
            function decodeQRCode() {
                if (!selectedFile) {
                    showDecodeError('请先上传图片');
                    return;
                }
                
                // 创建canvas用于解码
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 设置canvas大小
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // 绘制图像
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    
                    // 获取图像数据
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // 使用jsQR解码
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert"
                    });
                    
                    // 处理解码结果
                    if (code) {
                        decodeResult.value = code.data;
                        decodeResultContainer.classList.remove('hidden');
                        showDecodeSuccess('二维码解码成功');
                    } else {
                        showDecodeError('未检测到二维码或解码失败，请尝试其他图片');
                    }
                };
                
                img.onerror = function() {
                    showDecodeError('图片加载失败，请重试');
                };
                
                img.src = imagePreview.src;
            }
            
            // 重置解码工具
            function resetDecodeTool() {
                imageInput.value = '';
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                decodeResult.value = '';
                decodeResultContainer.classList.add('hidden');
                selectedFile = null;
                decodeButton.disabled = true;
                decodeResetButton.disabled = true;
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');
            }
            
            // 复制解码结果
            function copyDecodeResult() {
                if (decodeResult.value) {
                    decodeResult.select();
                    decodeResult.setSelectionRange(0, 99999);
                    
                    try {
                        document.execCommand('copy');
                        showToast('success', '解码结果已复制到剪贴板');
                    } catch (err) {
                        showToast('error', '复制失败，请手动复制');
                    }
                }
            }
            
            // 绑定事件监听器
            if (dropArea) {
                // 点击上传区域触发文件选择
                dropArea.addEventListener('click', () => {
                    imageInput.click();
                });
                
                // 拖拽上传
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.classList.add('border-primary', 'bg-primary/5');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('border-primary', 'bg-primary/5');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const file = dt.files[0];
                    handleImageUpload(file);
                }
            }
            
            if (imageInput) {
                imageInput.addEventListener('change', () => {
                    handleImageUpload(imageInput.files[0]);
                });
            }
            
            if (decodeButton) {
                decodeButton.addEventListener('click', decodeQRCode);
            }
            
            if (decodeResetButton) {
                decodeResetButton.addEventListener('click', resetDecodeTool);
            }
            
            if (decodeCopyButton) {
                decodeCopyButton.addEventListener('click', copyDecodeResult);
            }
        }
        // Toast 通知函数
        function showToast(type, message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            // 移除之前的类型类
            toast.classList.remove('success', 'error', 'info');
            
            // 添加新的类型类
            toast.classList.add(type);
            
            // 更新消息内容
            toastMessage.textContent = message;
            
            // 更新图标
            const icon = toast.querySelector('i');
            icon.className = 'fa mr-2';
            
            if (type === 'success') {
                icon.classList.add('fa-check-circle');
            } else if (type === 'error') {
                icon.classList.add('fa-exclamation-circle');
            } else {
                icon.classList.add('fa-info-circle');
            }
            
            // 显示Toast
            toast.classList.add('show');
            
            // 设置定时器自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 表单验证函数
        function validateForm() {
            let isValid = true;
            const errorMessageElement = document.getElementById('errorMessage');
            const errorTextElement = document.getElementById('errorText');
            
            // 隐藏之前的错误消息
            errorMessageElement.classList.add('hidden');
            
            // 验证AppID (下拉选择)
            const appidSelect = document.getElementById('appid');
            const appid = appidSelect.value;
            
            if (!appid) {
                showError(appidSelect, '请选择AppID');
                isValid = false;
            } else {
                removeError(appidSelect);
            }
            
            // 验证MCID（非必填，但如果填写必须是数字）
            const mcidInput = document.getElementById('mcid');
            const mcid = mcidInput.value.trim();
            
            if (mcid && !/^[0-9]+$/.test(mcid)) {
                showError(mcidInput, 'MCID只能包含数字');
                isValid = false;
            } else {
                removeError(mcidInput);
            }
            
            return isValid;
        }
        
        // 显示输入框错误
        function showError(inputElement, message) {
            inputElement.classList.add('error', 'animate-shake');
            
            // 移除动画类，以便下次可以重新触发
            setTimeout(() => {
                inputElement.classList.remove('animate-shake');
            }, 500);
            
            const errorMessageElement = document.getElementById('errorMessage');
            const errorTextElement = document.getElementById('errorText');
            
            errorTextElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
        }
        
        // 移除输入框错误
        function removeError(inputElement) {
            inputElement.classList.remove('error');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化模块导航
            initModuleNavigation();
            
            // 初始化解码工具
            initDecodeTool();
            
            // 初始化AppID下拉选择框
            initAppidDropdown();
            
            // 初始化业务类型下拉框
            initBustypeDropdown();
            
            // 初始化默认二维码
            generateQRCode();
            
            // 为必填字段添加输入事件监听器
            const requiredInputs = ['appid', 'mcid'];
            requiredInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('change', function() {
                    if (this.classList.contains('error')) {
                        removeError(this);
                        document.getElementById('errorMessage').classList.add('hidden');
                    }
                });
                
                // 为mcid添加input事件
                if (id === 'mcid') {
                    input.addEventListener('input', function() {
                        if (this.classList.contains('error')) {
                            removeError(this);
                            document.getElementById('errorMessage').classList.add('hidden');
                        }
                    });
                }
            });
            
            // 初始化AppID下拉选择框
            function initAppidDropdown() {
                const appidSelect = document.getElementById('appid');
                
                // 清空现有选项
                appidSelect.innerHTML = '';
                
                // 添加默认占位选项
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- 请选择AppID --';
                placeholderOption.selected = true;
                placeholderOption.disabled = true;
                appidSelect.appendChild(placeholderOption);
                
                // 从配置中添加AppID选项
                if (typeof config !== 'undefined' && config.appidList && config.appidList.length > 0) {
                    config.appidList.forEach((app, index) => {
                        const option = document.createElement('option');
                        option.value = app.value;
                        option.textContent = app.name + ' (' + app.value + ')';
                        
                        // 默认选中第一个有效选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        appidSelect.appendChild(option);
                    });
                } else {
                    // 如果配置未定义，添加默认选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'wx713931c9accc58f1';
                    defaultOption.textContent = '默认应用 (wx713931c9accc58f1)';
                    defaultOption.selected = true;
                    appidSelect.appendChild(defaultOption);
                }
            }
            
            // 初始化业务类型下拉框
            function initBustypeDropdown() {
                const bustypeSelect = document.getElementById('bustype');
                
                // 清空现有选项
                bustypeSelect.innerHTML = '';
                
                // 添加默认占位选项
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- 请选择业务类型 --';
                placeholderOption.selected = true;
                placeholderOption.disabled = true;
                bustypeSelect.appendChild(placeholderOption);
                
                // 从配置中添加业务类型选项
                if (typeof config !== 'undefined' && config.bustypeList && config.bustypeList.length > 0) {
                    config.bustypeList.forEach((bustype, index) => {
                        const option = document.createElement('option');
                        option.value = bustype.value;
                        option.textContent = bustype.name + ' (' + bustype.value + ')';
                        
                        // 默认选中第一个有效选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        bustypeSelect.appendChild(option);
                    });
                } else {
                    // 如果配置未定义，添加默认选项
                    const defaultOptions = [
                        {value: 'WM', name: '外卖'},
                        {value: 'JD', name: '京东'},
                        {value: 'EL', name: '饿了么'},
                        {value: 'OTHER', name: '其他'}
                    ];
                    
                    defaultOptions.forEach((opt, index) => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.name + ' (' + opt.value + ')';
                        
                        // 默认选中第一个选项
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        bustypeSelect.appendChild(option);
                    });
                }
                
                // 设置默认值（如果配置中有指定）
                if (typeof config !== 'undefined' && config.defaultParams && config.defaultParams.bustype) {
                    bustypeSelect.value = config.defaultParams.bustype;
                }
            }
            
            // 监听表单提交事件
            document.getElementById('qrForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 验证表单
                if (validateForm()) {
                    generateQRCode();
                    
                    // 显示成功消息
                    const successMessage = document.getElementById('successMessage');
                    const successText = document.getElementById('successText');
                    successText.textContent = '二维码生成成功！';
                    successMessage.classList.remove('hidden');
                    
                    // 3秒后隐藏成功消息
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 3000);
                    
                    // 添加提交动画效果
                    const submitButton = this.querySelector('button[type="submit"]');
                    submitButton.classList.add('animate-pulse');
                    setTimeout(() => {
                        submitButton.classList.remove('animate-pulse');
                    }, 1000);
                }
            });
            
            // 监听滑块变化
            document.getElementById('qrsize').addEventListener('input', function() {
                document.getElementById('qrsizeValue').textContent = this.value + 'px';
            });
            
            // 复制链接功能
            document.getElementById('copyButton').addEventListener('click', function() {
                const urlInput = document.getElementById('generatedUrl');
                
                try {
                    // 尝试使用现代的 Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(urlInput.value).then(() => {
                            showToast('success', '链接已复制到剪贴板');
                        }).catch(() => {
                            // 降级到传统方法
                            fallbackCopyTextToClipboard(urlInput);
                        });
                    } else {
                        // 降级到传统方法
                        fallbackCopyTextToClipboard(urlInput);
                    }
                } catch (err) {
                    showToast('error', '复制失败，请手动复制');
                }
            });
            
            // 传统的复制文本方法
            function fallbackCopyTextToClipboard(inputElement) {
                inputElement.select();
                inputElement.setSelectionRange(0, 99999); // 兼容移动设备
                
                if (document.execCommand('copy')) {
                    showToast('success', '链接已复制到剪贴板');
                } else {
                    showToast('error', '复制失败，请手动复制');
                }
            }
            
            // 下载二维码功能
            document.getElementById('downloadButton').addEventListener('click', function() {
                const canvas = document.querySelector('#qrcode canvas');
                if (canvas) {
                    try {
                        const link = document.createElement('a');
                        link.download = 'wechat_qrcode_' + new Date().getTime() + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        showToast('success', '二维码下载成功');
                    } catch (err) {
                        showToast('error', '下载失败，请重试');
                    }
                } else {
                    showToast('error', '二维码未生成，请先生成二维码');
                }
            });
            
            // 为二维码大小滑块添加实时更新功能
            document.getElementById('qrsize').addEventListener('input', function() {
                // 更新显示的大小值
                const sizeValue = this.value;
                document.getElementById('qrsizeValue').textContent = sizeValue + 'px';
                
                // 验证表单并实时更新二维码大小
                if (validateForm()) {
                    generateQRCode();
                }
            });
            
            // 重置功能
            document.getElementById('resetButton').addEventListener('click', function() {
                // 重置表单
                document.getElementById('qrForm').reset();
                document.getElementById('qrsizeValue').textContent = '250px';
                
                // 重置下拉框
                initAppidDropdown();
                initBustypeDropdown();
                
                // 如果有默认参数配置，应用默认值
                if (typeof config !== 'undefined' && config.defaultParams) {
                    const defaults = config.defaultParams;
                    // mcid不再设置默认值，保持为空
                    document.getElementById('tableno').value = defaults.tableno || '001';
                    document.getElementById('qrsize').value = defaults.qrsize || 250;
                    document.getElementById('qrsizeValue').textContent = (defaults.qrsize || 250) + 'px';
                }
                
                // 移除所有错误状态
                document.querySelectorAll('.form-input').forEach(input => {
                    removeError(input);
                });
                document.getElementById('errorMessage').classList.add('hidden');
                
                // 重置后重新生成默认二维码
                generateQRCode();
                showToast('info', '已重置为默认值');
            });
        });
        
        // 生成二维码的函数
        function generateQRCode() {
            // 显示加载指示器
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            // 获取表单值
            const appid = document.getElementById('appid').value.trim() || 'wx713931c9accc58f1';
            const mcid = document.getElementById('mcid').value.trim();
            const tableno = document.getElementById('tableno').value.trim() || '001'; // 非必填，不设置默认值
            const bustype = document.getElementById('bustype').value || 'WM';
            const qrsize = parseInt(document.getElementById('qrsize').value) || 250;
            
            try {
                // 根据bustype从配置中获取pathTemplate
                let path;
                
                if (typeof config !== 'undefined' && config.bustypeList) {
                    const selectedBustype = config.bustypeList.find(item => item.value === bustype);
                    if (selectedBustype && selectedBustype.pathTemplate) {
                        // 使用pathTemplate并根据mcid是否存在决定是否替换占位符
                        if (mcid) {
                            path = selectedBustype.pathTemplate.replace('{{mcid}}', mcid).replace('{{tableno}}', tableno);
                        } else {
                            // 如果mcid为空，移除包含占位符的参数部分
                            path = selectedBustype.pathTemplate.replace(/(&|\?)mcid={{mcid}}/, '');
                        }
                    } else {
                        // 默认构建路径，根据mcid是否存在决定是否添加参数
                        path = 'pages/index/index.html?context=' + bustype + (mcid ? '&mcid=' + mcid : '') + '&tableno=' + tableno + '&iswxtpa=1#wechat-redirect';
                    }
                } else {
                    // 默认构建路径，根据mcid是否存在决定是否添加参数
                    path = 'pages/index/index.html?context=' + bustype + (mcid ? '&mcid=' + mcid : '') + '&tableno=' + tableno + '&iswxtpa=1#wechat-redirect';
                }
                
                // 对整个路径进行URL编码
                const encodedPath = encodeURIComponent(path);
                
                // 构建最终的URL
                const url = `https://open.weixin.qq.com/sns/getexpappinfo?appid=${appid}&path=${encodedPath}&iswxtpa=1#wechat-redirect`;
                
                // 更新显示的URL
                document.getElementById('generatedUrl').value = url;
                
                // 清空之前的二维码
                const qrcodeElement = document.getElementById('qrcode');
                qrcodeElement.innerHTML = '<canvas></canvas>';
                const canvas = qrcodeElement.querySelector('canvas');
                
                // 生成新的二维码
                QRCode.toCanvas(canvas, url, {
                    width: qrsize,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, function(error) {
                    // 隐藏加载指示器
                    loadingIndicator.classList.add('hidden');
                    
                    if (error) {
                        console.error('二维码生成错误:', error);
                        qrcodeElement.innerHTML = '<p class="text-red-500">生成二维码时出错，请重试</p>';
                        showToast('error', '生成二维码失败，请检查参数并重试');
                    } else {
                        // 添加生成成功的动画效果
                        qrcodeElement.classList.add('animate-fadeIn');
                        setTimeout(() => {
                            qrcodeElement.classList.remove('animate-fadeIn');
                        }, 500);
                    }
                });
            } catch (err) {
                // 隐藏加载指示器
                loadingIndicator.classList.add('hidden');
                console.error('生成过程中发生错误:', err);
                showToast('error', '生成二维码时发生错误，请重试');
            }
        }
    </script>
</body>
</html>